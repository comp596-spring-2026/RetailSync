name: Deploy to Production

on:
  push:
    branches:
      - production
      - development

concurrency:
  group: deploy-production
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    if: github.ref == 'refs/heads/production'
    runs-on: ubuntu-latest
    environment: production
    env:
      GCP_PROJECT_ID: lively-infinity-488304-m9
      GCP_REGION: us-west1
      GAR_LOCATION: us-west1
      GAR_REPOSITORY: retailsync
      GAR_IMAGE_NAME: retailsync-api
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build shared
        run: pnpm --filter @retailsync/shared build

      - name: Build server
        working-directory: ./server
        run: pnpm build

      - name: Build client
        working-directory: ./client
        run: pnpm build

      - name: Validate required deployment inputs
        run: |
          missing=0
          for name in FIREBASE_TOKEN WIF_PROVIDER; do
            if [ -z "${!name}" ]; then
              echo "Missing required Actions secret/variable: $name"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          WIF_PROVIDER: ${{ vars.WIF_PROVIDER }}

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WIF_PROVIDER }}
          service_account: retailsync-ci-sa@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          create_credentials_file: true

      - name: Configure gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker "${{ env.GAR_LOCATION }}-docker.pkg.dev" --quiet

      - name: Build and push container
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.GAR_IMAGE_NAME }}:${{ github.sha }}"
          docker build -f server/Dockerfile -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        run: |
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.GAR_IMAGE_NAME }}:${{ github.sha }}"
          gcloud run deploy retailsync-api \
            --image "$IMAGE" \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --service-account "retailsync-run-sa@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com" \
            --set-secrets "MONGO_URI=MONGO_URI:latest,JWT_ACCESS_SECRET=JWT_ACCESS_SECRET:latest,JWT_REFRESH_SECRET=JWT_REFRESH_SECRET:latest,GOOGLE_OAUTH_CLIENT_ID=GOOGLE_OAUTH_CLIENT_ID:latest,GOOGLE_OAUTH_CLIENT_SECRET=GOOGLE_OAUTH_CLIENT_SECRET:latest,GOOGLE_AUTH_REDIRECT_URI=GOOGLE_AUTH_REDIRECT_URI:latest,GOOGLE_INTEGRATION_REDIRECT_URI=GOOGLE_INTEGRATION_REDIRECT_URI:latest,ENCRYPTION_KEY=ENCRYPTION_KEY:latest,CRON_SECRET=CRON_SECRET:latest" \
            --set-env-vars "NODE_ENV=production,CLIENT_URL=https://${{ env.GCP_PROJECT_ID }}.web.app" \
            --allow-unauthenticated

      - name: Deploy client to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          VITE_API_URL: https://retailsync-api-qbdqiyjkbq-uw.a.run.app/api
        run: |
          cd client
          pnpm build
          npx firebase-tools deploy --only hosting --token "$FIREBASE_TOKEN"

      - name: Post-deploy smoke test
        run: |
          sleep 15
          curl --fail https://retailsync-api-qbdqiyjkbq-uw.a.run.app/health
