name: Deploy to Production

on:
  push:
    branches:
      - production

concurrency:
  group: deploy-production
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build server
        working-directory: ./server
        run: pnpm build

      - name: Build client
        working-directory: ./client
        run: pnpm build

      - name: Authenticate to GCP (OIDC)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WORKLOAD_IDENTITY_POOL }}/providers/${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: retailsync-run-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Configure gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Set gcloud defaults
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region us-west1

      - name: Build and push container
        run: |
          IMAGE="gcr.io/${{ secrets.GCP_PROJECT_ID }}/retailsync-api:${{ github.sha }}"
          docker build -t "$IMAGE" ./server
          docker push "$IMAGE"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy retailsync-api \
            --image "gcr.io/${{ secrets.GCP_PROJECT_ID }}/retailsync-api:${{ github.sha }}" \
            --region us-west1 \
            --platform managed \
            --service-account "retailsync-run-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com" \
            --set-secrets "MONGO_URI=MONGO_URI:latest,JWT_ACCESS_SECRET=JWT_ACCESS_SECRET:latest,JWT_REFRESH_SECRET=JWT_REFRESH_SECRET:latest,GOOGLE_OAUTH_CLIENT_ID=GOOGLE_OAUTH_CLIENT_ID:latest,GOOGLE_OAUTH_CLIENT_SECRET=GOOGLE_OAUTH_CLIENT_SECRET:latest,GOOGLE_AUTH_REDIRECT_URI=GOOGLE_AUTH_REDIRECT_URI:latest,GOOGLE_INTEGRATION_REDIRECT_URI=GOOGLE_INTEGRATION_REDIRECT_URI:latest,ENCRYPTION_KEY=ENCRYPTION_KEY:latest" \
            --set-env-vars "NODE_ENV=production,CLIENT_URL=https://${{ secrets.GCP_PROJECT_ID }}.web.app" \
            --allow-unauthenticated

      - name: Deploy client to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          VITE_API_URL: https://retailsync-api-qbdqiyjkbq-uw.a.run.app/api
        run: |
          cd client
          pnpm build
          npx firebase-tools deploy --only hosting --token "$FIREBASE_TOKEN"

      - name: Post-deploy smoke test
        run: |
          sleep 15
          curl --fail https://retailsync-api-qbdqiyjkbq-uw.a.run.app/health
